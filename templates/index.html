<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üé•</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Video Stream Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #221f26 0%, #3d1e05 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        h1::before {
            content: "";
            display: block;
            height: 8px;
            margin: 8px auto;
            background-image: linear-gradient(to bottom, #333 0px, #333 4px, /* linea SPESSA (4px) sopra */ transparent 4px, transparent 6px, #333 6px, #333 8px /* linea SOTTILE (2px) sotto */);
        }
        h1::after {
            content: "";
            display: block;
            height: 8px;
            margin: 8px auto;
            background-image: linear-gradient(to bottom, #333 0px, #333 2px, /* linea SOTTILE (2px) sopra */ transparent 2px, transparent 4px, #333 4px, #333 8px /* linea SPESSA (4px) sotto */);
        }
        .header h1 {
            color: #333;
            margin-bottom: 5px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            text-align: center;
            justify-content: center;
            font-family: "Bodoni MT", "Bodoni", "Didot", "Times New Roman", serif;

        }
        .header-subtitle {
            color: #666;
            font-size: 14px;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .config-info-box {
            margin-top: 10px;
            padding: 10px 12px;
            background: #eef2ff;
            border-left: 4px solid #4f46e5;
            border-radius: 8px;
            font-size: 13px;
            color: #374151;
        }
        .btn-logout {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-logout:hover {
            background: #dc2626;
        }
        .btn-settings {
            padding: 8px 16px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-settings:hover {
            background: #7c3aed;
        }
        .btn-restart {
            padding: 8px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-restart:hover {
            background: #d97706;
        }
        .system-info {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .source-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .source-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        .radio-group {
            display: flex;
            gap: 20px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .radio-option input[type="radio"] {
            width: auto;
        }
        .video-upload-section {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px dashed #667eea;
        }
        .video-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .video-item {
            padding: 8px;
            background: white;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-card {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            flex: 1;
        }
        .info-card label {
            font-size: 12px;
            color: #666;
            display: block;
        }
        .info-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        .stream-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .stream-section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-running { background: #10b981; color: white; }
        .status-stopped { background: #ef4444; color: white; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start {
            background: #10b981;
            color: white;
        }
        .btn-start:hover { background: #059669; }
        .btn-stop {
            background: #ef4444;
            color: white;
        }
        .btn-stop:hover { background: #dc2626; }
        .btn-save {
            background: #667eea;
            color: white;
        }
        .btn-save:hover { background: #5568d3; }
        .btn-restart-service {
            background: #f59e0b;
            color: white;
        }
        .btn-restart-service:hover { background: #d97706; }
        .stream-preview {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stream-url {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 10px;
            word-break: break-all;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .stream-url:hover {
            background-color: #e8f4f8;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .stream-url a {
            color: #0066cc;
            text-decoration: none;
        }
        .stream-url a:hover {
            text-decoration: underline;
            color: #0052a3;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .modal-header h2 {
            color: #333;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .auth-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .auth-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="header">
            <div class="header-top">
                <div>
                    <img src="../static/stemma_small.png" alt="Stemma" style="height: 50px; vertical-align: middle;">
                    <h1>Video Stream Manager</h1>
                    <p class="header-subtitle">Converti una sorgente video in uno stream</p>
                </div>
            </div>
            <div class="header-top">
                <div class="header-buttons">
                    <button class="btn-restart" onclick="restartService()" title="Riavvia il servizio stream-manager">
                        üîÑ Riavvia Servizio
                    </button>
                    <button class="btn-restart" onclick="rebootSystem()" title="Riavvia il dispositivo" style="background: #f97316;">
                        üîå Riavvia Dispositivo
                    </button>
                    <a href="#" class="btn-settings" onclick="openNetworkModal(); return false;">üåê Rete</a>
                    <a href="#" class="btn-settings" onclick="openSecurityModal(); return false;">üîê Utente/Password</a>
                    <a href="/logout" class="btn-logout">üö™ Esci</a>
                </div>
            </div>

            <div class="config-info-box" id="config-info">
                Tommaso v2.20251208.
            </div>

            <div class="system-info">
                <div class="info-card">
                    <label>CPU</label>
                    <div class="value" id="cpu">--</div>
                </div>
                <div class="info-card">
                    <label>Memoria</label>
                    <div class="value" id="memory">--</div>
                </div>
                <div class="info-card">
                    <label>Temperatura</label>
                    <div class="value" id="temp">--</div>
                </div>
            </div>
        </div>

        <!-- MJPG Streamer Section -->
        <div class="stream-section">
            <h2>
                MJPG Streamer
                <span class="status-badge" id="mjpg-status">Fermo</span>
            </h2>

            <div class="source-selector">
                <label>üé¨ Sorgente Video</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="mjpg-source-device" name="mjpg-source" value="device" checked>
                        <label for="mjpg-source-device">üìπ Dispositivo USB</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="mjpg-source-video" name="mjpg-source" value="video">
                        <label for="mjpg-source-video">üé• File Video (Loop)</label>
                    </div>
                </div>
            </div>

            <form id="mjpg-form">
                <!-- Campo nascosto per il tipo di sorgente -->
                <input type="hidden" name="source_type" id="mjpg-source-type" value="device">
                
                <div class="form-row">
                    <div class="form-group" id="mjpg-device-group">
                        <label>Dispositivo Video</label>
                        <select name="device" id="mjpg-device">
                            {% for device in devices %}
                            <option value="{{ device }}">{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" id="mjpg-video-group" style="display:none;">
                        <label>File Video</label>
                        <select name="video_file" id="mjpg-video-file">
                            <option value="">Carica un video...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Risoluzione</label>
                        <select name="resolution">
                            <option value="320x240">320x240</option>
                            <option value="640x480" selected>640x480</option>
                            <option value="800x600">800x600</option>
                            <option value="1280x720">1280x720</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Framerate (fps)</label>
                        <input type="number" name="framerate" value="15" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>Qualit√† (0-100)</label>
                        <input type="number" name="quality" value="85" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Porta HTTP</label>
                        <input type="number" name="port" value="8080" min="1024" max="65535">
                    </div>
                </div>

                <div class="video-upload-section" id="mjpg-upload-section" style="display:none;">
                    <label><strong>üì§ Carica Video</strong></label>
                    <p style="font-size: 12px; color: #666; margin: 5px 0;">
                        Formati supportati: MP4, AVI, MKV, MOV, MPG
                    </p>
                    <input type="file" id="mjpg-video-upload" accept="video/*" style="margin-top: 10px;">
                    <button type="button" class="btn-save" onclick="uploadVideo('mjpg')" style="margin-top: 10px;">
                        ‚¨ÜÔ∏è Carica Video
                    </button>

                    <div class="video-list" id="mjpg-video-list"></div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="autostart" id="mjpg-autostart" style="width: auto;">
                        <span>Avvio automatico al boot del Raspberry</span>
                    </label>
                </div>

                <!-- Autenticazione MJPG -->
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" name="auth_enabled" id="mjpg-auth-enabled" style="width: auto;" checked>
                        <strong>üîê Proteggi stream con password</strong>
                    </label>
                    
                    <div id="mjpg-auth-fields">
                        <div class="form-row" style="margin-top: 10px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Username Stream</label>
                                <input type="text" name="auth_username" id="mjpg-auth-username" value="stream" placeholder="Username per accesso stream">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Password Stream</label>
                                <input type="password" name="auth_password" id="mjpg-auth-password" value="stream" placeholder="Password per accesso stream">
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #856404; margin-top: 10px;">
                            ‚ÑπÔ∏è Gli utenti dovranno inserire queste credenziali per visualizzare lo stream MJPG
                        </p>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn-start" onclick="startMJPG()">‚ñ∂ Avvia</button>
                    <button type="button" class="btn-stop" onclick="stopMJPG()">‚èπ Ferma</button>
                    <button type="button" class="btn-save" onclick="saveMJPGConfig()">üíæ Salva Config</button>
                    <button type="button" class="btn-restart-service" onclick="restartMJPG()">üîÑ Riavvia MJPG</button>
                </div>
            </form>

            <div class="stream-preview">
                <strong>URL Stream:</strong>
                <div class="stream-url" id="mjpg-url" title="Clicca per copiare l'URL" style="cursor: pointer;" onclick="copyMjpgUrl()">
                    <a href="http://[IP_RASPBERRY]:8080/?action=stream" id="mjpg-url-link" target="_blank" style="color: inherit;"></a>
                </div>
            </div>
        </div>

        <!-- RTSP Stream Section -->
        <div class="stream-section">
            <h2>
                RTSP Stream (FFmpeg)
                <span class="status-badge" id="rtsp-status">Fermo</span>
            </h2>

            <div class="source-selector">
                <label>üé¨ Sorgente Video</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="rtsp-source-device" name="rtsp-source" value="device" checked>
                        <label for="rtsp-source-device">üìπ Dispositivo USB</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="rtsp-source-video" name="rtsp-source" value="video">
                        <label for="rtsp-source-video">üé• File Video (Loop)</label>
                    </div>
                </div>
            </div>

            <form id="rtsp-form">
                <!-- Campo nascosto per il tipo di sorgente -->
                <input type="hidden" name="source_type" id="rtsp-source-type" value="device">
                
                <div class="form-row">
                    <div class="form-group" id="rtsp-device-group">
                        <label>Dispositivo Video</label>
                        <select name="device" id="rtsp-device">
                            {% for device in devices %}
                            <option value="{{ device }}">{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" id="rtsp-video-group" style="display:none;">
                        <label>File Video</label>
                        <select name="video_file" id="rtsp-video-file">
                            <option value="">Carica un video...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Risoluzione</label>
                        <select name="resolution">
                            <option value="320x240">320x240</option>
                            <option value="640x480" selected>640x480</option>
                            <option value="800x600">800x600</option>
                            <option value="1280x720">1280x720</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Framerate (fps)</label>
                        <input type="number" name="framerate" value="25" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>Bitrate</label>
                        <select name="bitrate">
                            <option value="500k">500 kbps</option>
                            <option value="1000k" selected>1 Mbps</option>
                            <option value="2000k">2 Mbps</option>
                            <option value="4000k">4 Mbps</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Porta RTSP</label>
                        <input type="number" name="port" value="8554" min="1024" max="65535">
                    </div>
                </div>

                <div class="video-upload-section" id="rtsp-upload-section" style="display:none;">
                    <label><strong>üì§ Carica Video</strong></label>
                    <p style="font-size: 12px; color: #666; margin: 5px 0;">
                        Formati supportati: MP4, AVI, MKV, MOV, MPG
                    </p>
                    <input type="file" id="rtsp-video-upload" accept="video/*" style="margin-top: 10px;">
                    <button type="button" class="btn-save" onclick="uploadVideo('rtsp')" style="margin-top: 10px;">
                        ‚¨ÜÔ∏è Carica Video
                    </button>

                    <div class="video-list" id="rtsp-video-list"></div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="autostart" id="rtsp-autostart" style="width: auto;">
                        <span>Avvio automatico al boot del Raspberry</span>
                    </label>
                </div>

                <!-- Autenticazione RTSP -->
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" name="auth_enabled" id="rtsp-auth-enabled" style="width: auto;" checked>
                        <strong>üîê Proteggi stream con password</strong>
                    </label>
                    
                    <div id="rtsp-auth-fields">
                        <div class="form-row" style="margin-top: 10px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Username Stream</label>
                                <input type="text" name="auth_username" id="rtsp-auth-username" value="stream" placeholder="Username per accesso stream">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Password Stream</label>
                                <input type="password" name="auth_password" id="rtsp-auth-password" value="stream" placeholder="Password per accesso stream">
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #856404; margin-top: 10px;">
                            ‚ÑπÔ∏è URL con autenticazione: <code>rtsp://username:password@[IP]:8554/video</code>
                        </p>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn-start" onclick="startRTSP()">‚ñ∂ Avvia</button>
                    <button type="button" class="btn-stop" onclick="stopRTSP()">‚èπ Ferma</button>
                    <button type="button" class="btn-save" onclick="saveRTSPConfig()">üíæ Salva Config</button>
                    <button type="button" class="btn-restart-service" onclick="restartRTSP()">üîÑ Riavvia RTSP</button>
                </div>
            </form>


            <div class="stream-preview">
                <strong>URL Stream RTSP:</strong>
                <div class="stream-url" id="rtsp-url" title="Clicca per copiare l'URL" style="cursor: pointer;" onclick="copyRtspUrl()">
                    <a href="#" id="rtsp-url-link" style="color: inherit; text-decoration: none;" onclick="return copyRtspUrl()">rtsp://[IP_RASPBERRY]:8554/video</a>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                Clicca per copiare ‚Ä¢ Usa VLC o altro player RTSP per visualizzare lo stream
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Rete -->
    <div id="networkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeNetworkModal()">&times;</span>
                <h2>üåê Configurazione Rete</h2>
            </div>

            <!-- Sezione informazioni correnti -->
            <div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #166534;">üìä Stato Attuale</h3>
                <div style="display: grid;">
                    <div>
                        <strong style="color: #065f46;">Nome Rete WiFi:</strong>
                        <span id="current-network-display" style="color: #0f766e; font-weight: bold;">Caricamento...</span>
                    </div>
                    <div>
                        <strong style="color: #065f46;">IP Corrente:</strong>
                        <span id="current-ip-display" style="color: #0f766e; font-weight: bold;">Caricamento...</span>
                    </div>
                    <div>
                        <strong style="color: #065f46;">Modalit√†:</strong>
                        <span id="current-mode-display" style="color: #0f766e; font-weight: bold;">Caricamento...</span>
                    </div>
                    <div>
                        <strong style="color: #065f46;">Gateway:</strong>
                        <span id="current-gateway-display" style="color: #0f766e;">--</span>
                    </div>
                </div>
            </div>

            <div style="background: #e0f2fe; border-left: 4px solid #0284c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                
                <div class="form-group">
                    <label><strong>Nome Dispositivo (Hostname)</strong></label>
                    <input type="text" id="hostname-input" placeholder="Inserisci nuovo hostname" style="margin-bottom: 10px;">
                    <button type="button" class="btn-save" onclick="changeHostname()" style="padding: 10px 20px; font-size: 13px; width: 100%;">
                        üîÑ Cambia Hostname
                    </button>
                    <p style="font-size: 11px; color: #0c4a6e; margin-top: 8px;">
                        ‚ÑπÔ∏è Il dispositivo sar√† raggiungibile con il nuovo nome sulla rete
                    </p>
                </div>

                <hr style="margin: 15px 0; border: none; border-top: 1px solid #0284c7;">

                <div style="margin-top: 15px;">
                    <label><strong>Configurazione Indirizzo IP</strong></label>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
                            <input type="radio" name="ip-mode" value="dhcp" id="ip-dhcp" checked>
                            <span>DHCP (Automatico)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="ip-mode" value="static" id="ip-static">
                            <span>IP Statico</span>
                        </label>
                    </div>

                    <!-- Sezione DHCP -->
                    <div id="dhcp-section" style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #0284c7;">
                        <div class="form-group">
                            <label>Interfaccia di Rete</label>
                            <select id="dhcp-interface" style="width: 100%;">
                                <option value="eth0">eth0 (Ethernet)</option>
                                <option value="wlan0">wlan0 (Wi-Fi)</option>
                            </select>
                        </div>
                        <button type="button" class="btn-save" onclick="applyDHCP()" style="width: 100%; padding: 10px;">
                            üîÑ Attiva DHCP
                        </button>
                    </div>

                    <!-- Sezione IP Statico (nascosta di default) -->
                    <div id="static-ip-section" style="display: none; margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #0284c7;">
                        <div class="form-group">
                            <label>Interfaccia di Rete</label>
                            <select id="network-interface" style="width: 100%;">
                                <option value="eth0">eth0 (Ethernet)</option>
                                <option value="wlan0">wlan0 (Wi-Fi)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Indirizzo IP</label>
                            <input type="text" id="static-ip" placeholder="es. 192.168.1.100">
                        </div>

                        <div class="form-group">
                            <label>Subnet Mask (CIDR)</label>
                            <select id="netmask" style="width: 100%;">
                                <option value="24">/24 (255.255.255.0)</option>
                                <option value="25">/25 (255.255.255.128)</option>
                                <option value="23">/23 (255.255.254.0)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Gateway (Router)</label>
                            <input type="text" id="gateway-ip" placeholder="es. 192.168.1.1">
                        </div>

                        <div class="form-group">
                            <label>Server DNS</label>
                            <input type="text" id="dns-servers" placeholder="es. 8.8.8.8" value="8.8.8.8">
                        </div>

                        <button type="button" class="btn-save" onclick="applyStaticIP()" style="width: 100%; padding: 10px;">
                            üíæ Applica IP Statico
                        </button>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 2px solid #0284c7;">

                <!-- Sezione Connessione WiFi -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-top: 0; color: #0c4a6e;">üì° Connessione WiFi</h3>
                    <button type="button" class="btn-save" onclick="scanWiFiNetworks()" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                        üîç Scansiona Reti WiFi
                    </button>
                    
                    <div id="wifi-networks-container" style="margin-top: 15px; display: none;">
                        <div style="background: white; border: 1px solid #0284c7; border-radius: 6px; padding: 12px;">
                            <div id="wifi-list" style="max-height: 200px; overflow-y: auto;">
                                <p style="text-align: center; color: #666;">Nessuna rete trovata</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione connessione manuale -->
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #0284c7;">
                        <h4 style="margin-top: 0;">Connessione Manuale</h4>
                        
                        <div class="form-group">
                            <label>SSID (Nome Rete)</label>
                            <input type="text" id="wifi-ssid" placeholder="Nome della rete WiFi">
                        </div>

                        <div class="form-group">
                            <label>Password (opzionale)</label>
                            <input type="password" id="wifi-password" placeholder="Password della rete">
                        </div>

                        <button type="button" class="btn-save" onclick="connectToWiFi()" style="width: 100%; padding: 10px;">
                            üîê Connetti a WiFi
                        </button>
                    </div>

                    <!-- Bottone elimina reti salvate -->
                    <div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-radius: 6px; border: 1px solid #fca5a5;">
                        <button type="button" class="btn-save" onclick="forgetAllWiFiNetworks()" style="width: 100%; padding: 10px; background: #dc2626; color: white;">
                            üóëÔ∏è Cancella Tutte le Reti Salvate
                        </button>
                        <p style="font-size: 11px; color: #7f1d1d; margin-top: 8px; margin-bottom: 0;">
                            ‚ö†Ô∏è Rimuove tutte le connessioni WiFi salvate. Il dispositivo perder√† la connessione se non connesso via Ethernet.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sicurezza -->
    <div id="securityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeSecurityModal()">&times;</span>
                <h2>üîê Sicurezza - Username e Password</h2>
            </div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                <div class="form-group">
                    <label>Nuovo Username</label>
                    <input type="text" id="new-username" placeholder="Lascia vuoto per non cambiare">
                </div>

                <div class="form-group">
                    <label>Nuova Password</label>
                    <input type="password" id="new-password" placeholder="Lascia vuoto per non cambiare">
                </div>

                <div class="form-group">
                    <label>Conferma Password</label>
                    <input type="password" id="confirm-password" placeholder="Conferma la nuova password">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="disable-auth" style="width: auto;">
                        <span>Disabilita autenticazione (non consigliato)</span>
                    </label>
                </div>

                <button type="button" class="btn-save" onclick="saveSettings()" style="width: 100%; padding: 12px; font-size: 14px;">
                    üíæ Salva Impostazioni
                </button>
            </div>
        </div>
    </div>

    <script>
        // Gestione visibilit√† campi autenticazione MJPG
        document.getElementById('mjpg-auth-enabled').addEventListener('change', function() {
            const fields = document.getElementById('mjpg-auth-fields');
            fields.style.display = this.checked ? 'block' : 'none';
        });

        // Gestione visibilit√† campi autenticazione RTSP
        document.getElementById('rtsp-auth-enabled').addEventListener('change', function() {
            const fields = document.getElementById('rtsp-auth-fields');
            fields.style.display = this.checked ? 'block' : 'none';
        });

        // Gestione sorgente video MJPG
        document.querySelectorAll('input[name="mjpg-source"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deviceGroup = document.getElementById('mjpg-device-group');
                const videoGroup = document.getElementById('mjpg-video-group');
                const uploadSection = document.getElementById('mjpg-upload-section');
                const sourceTypeInput = document.getElementById('mjpg-source-type');

                if (this.value === 'device') {
                    deviceGroup.style.display = 'block';
                    videoGroup.style.display = 'none';
                    uploadSection.style.display = 'none';
                    sourceTypeInput.value = 'device';
                } else {
                    deviceGroup.style.display = 'none';
                    videoGroup.style.display = 'block';
                    uploadSection.style.display = 'block';
                    sourceTypeInput.value = 'video';
                    loadVideoList('mjpg');
                }
            });
        });

        // Gestione sorgente video RTSP
        document.querySelectorAll('input[name="rtsp-source"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deviceGroup = document.getElementById('rtsp-device-group');
                const videoGroup = document.getElementById('rtsp-video-group');
                const uploadSection = document.getElementById('rtsp-upload-section');
                const sourceTypeInput = document.getElementById('rtsp-source-type');

                if (this.value === 'device') {
                    deviceGroup.style.display = 'block';
                    videoGroup.style.display = 'none';
                    uploadSection.style.display = 'none';
                    sourceTypeInput.value = 'device';
                } else {
                    deviceGroup.style.display = 'none';
                    videoGroup.style.display = 'block';
                    uploadSection.style.display = 'block';
                    sourceTypeInput.value = 'video';
                    loadVideoList('rtsp');
                }
            });
        });

        // Gestione modalit√† IP (DHCP/Statico)
        document.querySelectorAll('input[name="ip-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const staticSection = document.getElementById('static-ip-section');
                const dhcpSection = document.getElementById('dhcp-section');
                
                if (this.value === 'static') {
                    staticSection.style.display = 'block';
                    dhcpSection.style.display = 'none';
                } else {
                    staticSection.style.display = 'none';
                    dhcpSection.style.display = 'block';
                }
            });
        });

        // Funzioni di gestione rete
        function changeHostname() {
            const hostnameInput = document.getElementById('hostname-input');
            const newHostname = hostnameInput.value.trim();

            if (!newHostname) {
                showNotification('Inserisci un hostname valido', 'error');
                return;
            }

            if (!/^[a-z0-9-]{1,63}$/i.test(newHostname)) {
                showNotification('Hostname non valido. Usa solo lettere, numeri e trattini', 'error');
                return;
            }

            showNotification('Cambio hostname in corso...', 'warning');

            const formData = new FormData();
            formData.append('hostname', newHostname);

            fetch('/api/network/hostname', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ Hostname cambiato con successo!', 'success');
                    hostnameInput.value = '';
                    setTimeout(() => {
                        showNotification('‚ö†Ô∏è Collegati di nuovo al dispositivo con il nuovo nome', 'warning');
                    }, 1500);
                } else {
                    showNotification('Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            });
        }

        function applyStaticIP() {
            const interface = document.getElementById('network-interface').value;
            const ip = document.getElementById('static-ip').value.trim();
            const netmask = document.getElementById('netmask').value;
            const gateway = document.getElementById('gateway-ip').value.trim();
            const dns = document.getElementById('dns-servers').value.trim();

            if (!ip || !gateway) {
                showNotification('Compila i campi obbligatori', 'error');
                return;
            }

            if (!confirm('ATTENZIONE!\n\nStai per cambiare l\'IP in: ' + ip + '\n\n1. La configurazione verr√† applicata\n2. La pagina cercher√† di riconnettersi al nuovo IP\n3. Se non si connette, accedi manualmente a: http://' + ip + '\n\nContinuare?')) {
                return;
            }

            showNotification('‚è≥ Applicazione IP statico in corso... (non chiudere questa pagina)', 'warning');

            const formData = new FormData();
            formData.append('interface', interface);
            formData.append('ip_address', ip);
            formData.append('netmask', netmask);
            formData.append('gateway', gateway);
            formData.append('dns', dns);

            fetch('/api/network/ip/static', {
                method: 'POST',
                body: formData,
                timeout: 30000
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ Configurazione applicata! Attendo il riavvio della rete... (10 secondi)', 'success');
                    closeNetworkModal();
                    
                    // Aspetta 10 secondi prima di provare a riconnettersi
                    setTimeout(() => {
                        showNotification('üîÑ Tentativo di riconnessione a: ' + ip, 'warning');
                        window.location.href = 'http://' + ip;
                    }, 10000);
                } else {
                    showNotification('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => {
                // Se c'√® timeout o errore di rete, prova comunque a riconnettersi
                showNotification('‚ö†Ô∏è Timeout connessione (normale). Riconessione in corso...', 'warning');
                setTimeout(() => {
                    window.location.href = 'http://' + ip;
                }, 8000);
            });
        }

        function applyDHCP() {
            const interface = document.getElementById('dhcp-interface').value;

            if (!confirm('Attivare DHCP su ' + interface + '?\n\nIl dispositivo ricever√† un IP automaticamente dal router.\nLa pagina si ricaricher√† dopo 10 secondi.')) {
                return;
            }

            showNotification('‚è≥ Attivazione DHCP in corso... (non chiudere questa pagina)', 'warning');

            const formData = new FormData();
            formData.append('interface', interface);

            fetch('/api/network/ip/dhcp', {
                method: 'POST',
                body: formData,
                timeout: 30000
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ DHCP attivato! Attendo il riavvio della rete... (10 secondi)', 'success');
                    closeNetworkModal();
                    
                    // Aspetta 10 secondi prima di ricaricare la pagina
                    setTimeout(() => {
                        showNotification('üîÑ Ricaricamento pagina...', 'warning');
                        window.location.reload();
                    }, 10000);
                } else {
                    showNotification('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => {
                // Se c'√® timeout, riprova comunque a ricaricare
                showNotification('‚ö†Ô∏è Timeout connessione (normale). Ricaricamento in corso...', 'warning');
                setTimeout(() => {
                    window.location.reload();
                }, 8000);
            });
        }

        // Carica lista video
        function loadVideoList(type, selectedPath = null) {
            console.log('[DEBUG] loadVideoList called for type:', type);
            fetch('/api/videos/list')
                .then(r => {
                    console.log('[DEBUG] Response status:', r.status);
                    if (!r.ok) {
                        throw new Error('HTTP ' + r.status);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('[DEBUG] Videos loaded:', data);
                    const select = document.getElementById(`${type}-video-file`);
                    const list = document.getElementById(`${type}-video-list`);
                    
                    if (!select || !list) {
                        console.error('[ERROR] Elements not found:', { select, list });
                        return;
                    }
                    
                    // Aggiorna select
                    select.innerHTML = '<option value="">Seleziona un video...</option>';
                    data.videos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.path;
                        option.textContent = video.name;
                        select.appendChild(option);
                    });

                    // Se ho un path salvato, selezionalo
                    if (selectedPath) {
                        select.value = selectedPath;
                    }
                    
                    // Aggiorna lista
                    list.innerHTML = '';
                    data.videos.forEach(video => {
                        const item = document.createElement('div');
                        item.className = 'video-item';
                        item.innerHTML = `
                            <span>üé¨ ${video.name} (${video.size})</span>
                            <button onclick="deleteVideo('${video.name}')" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">üóëÔ∏è</button>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(err => {
                    console.error('[ERROR] loadVideoList failed:', err);
                    showNotification('Errore caricamento video: ' + err, 'error');
                });
        }

        // Upload video
        function uploadVideo(type) {
            const fileInput = document.getElementById(`${type}-video-upload`);
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Seleziona un file video', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('video', file);

            showNotification('Caricamento in corso... (' + file.name + ')', 'success');
            console.log('[DEBUG] Caricamento video:', file.name, 'Size:', file.size);

            fetch('/api/videos/upload', {
                method: 'POST',
                body: formData
            })
            .then(r => {
                console.log('[DEBUG] Response status:', r.status);
                return r.json();
            })
            .then(data => {
                console.log('[DEBUG] Upload response:', data);
                if (data.success) {
                    showNotification('Video caricato con successo!', 'success');
                    fileInput.value = '';
                    loadVideoList(type);
                } else {
                    showNotification('Errore: ' + data.error, 'error');
                }
            })
            .catch(err => {
                console.error('[ERROR] Upload failed:', err);
                showNotification('Errore caricamento: ' + err.message, 'error');
            });
        }

        // Elimina video
        function deleteVideo(filename) {
            if (!confirm(`Eliminare il video "${filename}"?`)) return;

            fetch('/api/videos/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Video eliminato', 'success');
                    loadVideoList('mjpg');
                    loadVideoList('rtsp');
                } else {
                    showNotification('Errore: ' + data.error, 'error');
                }
            });
        }

        // Riavvia il servizio stream-manager
        function restartService() {
            if (!confirm('Riavviare il servizio stream-manager? Questo fermer√† temporaneamente tutti gli stream.')) return;
            
            showNotification('Riavvio servizio in corso...', 'warning');
            
            fetch('/api/service/restart', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Servizio riavviato con successo! Ricarica la pagina tra 5 secondi...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    showNotification('Errore nel riavvio: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('Errore: ' + err.message, 'error'));
        }

        function rebootSystem() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nStai per riavviare il dispositivo.\n\nTutti i servizi verranno interrotti.\n\nContinuare?')) {
                return;
            }
            
            showNotification('üîå Riavvio del dispositivo in corso... La connessione sar√† persa.', 'warning');
            
            fetch('/api/system/reboot', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ ' + data.message, 'success');
                    // Dopo 5 secondi, prova a ricaricare
                    setTimeout(() => {
                        window.location.reload();
                    }, 10000);
                } else {
                    showNotification('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('‚ö†Ô∏è Riavvio in corso... La pagina si ricaricher√† automaticamente.', 'warning'));
        }


        // Riavvia solo MJPG
        function restartMJPG() {
            stopMJPG();
            setTimeout(() => {
                startMJPG();
            }, 1000);
        }

        // Riavvia solo RTSP
        function restartRTSP() {
            stopRTSP();
            setTimeout(() => {
                startRTSP();
            }, 1000);
        }

        // Aggiorna lo stato ogni 2 secondi
        setInterval(updateStatus, 2000);
        updateStatus();

        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Aggiorna badge status
                    updateBadge('mjpg-status', data.mjpg_running);
                    updateBadge('rtsp-status', data.rtsp_running);

                    // Aggiorna info di sistema
                    document.getElementById('cpu').textContent = data.system.cpu.toFixed(1) + '%';
                    document.getElementById('memory').textContent = data.system.memory.toFixed(1) + '%';
                    document.getElementById('temp').textContent = data.system.temperature.toFixed(1) + '¬∞C';

                    // Aggiorna URL
                    const hostname = window.location.hostname;
                    const mjpgUrl = `http://${hostname}:${data.config.mjpg.port}/?action=stream`;
                    const rtspUrl = `rtsp://${hostname}:${data.config.rtsp.port}/video`;
                    
                    // Aggiorna link MJPG
                    const mjpgLink = document.getElementById('mjpg-url-link');
                    mjpgLink.href = mjpgUrl;
                    mjpgLink.textContent = mjpgUrl;
                    
                    // Aggiorna link RTSP (copiar sul click)
                    const rtspLink = document.getElementById('rtsp-url-link');
                    rtspLink.textContent = rtspUrl;
                });
        }

        function updateBadge(id, running) {
            const badge = document.getElementById(id);
            if (running) {
                badge.textContent = 'In Esecuzione';
                badge.className = 'status-badge status-running';
            } else {
                badge.textContent = 'Fermo';
                badge.className = 'status-badge status-stopped';
            }
        }

        function showNotification(message, type) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        function startMJPG() {
            const form = document.getElementById('mjpg-form');
            const data = new FormData(form);

            // Aggiungi tipo sorgente (usa set per evitare duplicati)
            const sourceType = document.querySelector('input[name="mjpg-source"]:checked').value;
            data.set('source_type', sourceType);

            // Se la sorgente √® video, assicura che video_file sia presente
            if (sourceType === 'video') {
                const videoFile = document.getElementById('mjpg-video-file').value;
                if (!videoFile) {
                    showNotification('Seleziona un video prima di avviare!', 'error');
                    return;
                }
                data.set('video_file', videoFile);
            }

            fetch('/api/mjpg/start', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('‚úÖ MJPG Streamer avviato!', 'success');
                    updateStatus();
                } else {
                    showNotification('‚ùå Errore: ' + (result.error || 'Sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('‚ùå Errore di connessione: ' + err, 'error'));
        }

        function stopMJPG() {
            fetch('/api/mjpg/stop', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showNotification('MJPG Streamer fermato', 'success');
                    updateStatus();
                });
        }

        function saveMJPGConfig() {
            const form = document.getElementById('mjpg-form');
            const data = new FormData(form);

            // Aggiungi tipo sorgente
            const sourceType = document.querySelector('input[name="mjpg-source"]:checked').value;
            data.set('source_type', sourceType);

            // Se la sorgente √® video, assicura che video_file sia presente
            if (sourceType === 'video') {
                const videoFile = document.getElementById('mjpg-video-file').value;
                if (!videoFile) {
                    showNotification('Seleziona un video prima di salvare!', 'error');
                    return;
                }
                data.set('video_file', videoFile);
            }

            fetch('/api/mjpg/save', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('Configurazione MJPG salvata!', 'success');
                } else {
                    showNotification('Errore: ' + (result.error || 'Sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('Errore di connessione: ' + err, 'error'));
        }

        function startRTSP() {
            const form = document.getElementById('rtsp-form');
            const data = new FormData(form);

            // Aggiungi tipo sorgente (usa set per evitare duplicati)
            const sourceType = document.querySelector('input[name="rtsp-source"]:checked').value;
            data.set('source_type', sourceType);

            // Se la sorgente √® video, assicura che video_file sia presente
            if (sourceType === 'video') {
                const videoFile = document.getElementById('rtsp-video-file').value;
                if (!videoFile) {
                    showNotification('Seleziona un video prima di avviare!', 'error');
                    return;
                }
                data.set('video_file', videoFile);
            }

            fetch('/api/rtsp/start', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('‚úÖ Stream RTSP avviato!', 'success');
                    updateStatus();
                } else {
                    showNotification('‚ùå Errore: ' + (result.error || 'Sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('‚ùå Errore di connessione: ' + err, 'error'));
        }

        function stopRTSP() {
            fetch('/api/rtsp/stop', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showNotification('Stream RTSP fermato', 'success');
                    updateStatus();
                });
        }

        function saveRTSPConfig() {
            const form = document.getElementById('rtsp-form');
            const data = new FormData(form);

            // Aggiungi tipo sorgente
            const sourceType = document.querySelector('input[name="rtsp-source"]:checked').value;
            data.set('source_type', sourceType);

            // Se la sorgente √® video, assicura che video_file sia presente
            if (sourceType === 'video') {
                const videoFile = document.getElementById('rtsp-video-file').value;
                if (!videoFile) {
                    showNotification('Seleziona un video prima di salvare!', 'error');
                    return;
                }
                data.set('video_file', videoFile);
            }

            fetch('/api/rtsp/save', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('Configurazione RTSP salvata!', 'success');
                } else {
                    showNotification('Errore: ' + (result.error || 'Sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('Errore di connessione: ' + err, 'error'));
        }

        function scanWiFiNetworks() {
            showNotification('üîç Scansione reti WiFi in corso...', 'info');
            
            fetch('/api/wifi/scan')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.networks.length > 0) {
                        const container = document.getElementById('wifi-networks-container');
                        const list = document.getElementById('wifi-list');
                        
                        let html = '';
                        data.networks.forEach(net => {
                            // Il segnale da nmcli √® una percentuale 0-100
                            
                            // Calcola le barre (0-4) basate sulla percentuale
                            
                            html += `
                                <div style="padding: 10px; border-bottom: 1px solid #e0e7ff; cursor: pointer; border-radius: 4px; margin-bottom: 5px; background: #f8fafc; transition: background 0.2s;" 
                                     onmouseover="this.style.background='#e0f2fe'" 
                                     onmouseout="this.style.background='#f8fafc'"
                                     onclick="selectWiFiNetwork('${net.ssid.replace(/'/g, "\\'")}')">
                                </div>
                            `;
                        });
                        
                        list.innerHTML = html;
                        container.style.display = 'block';
                        showNotification('‚úÖ Trovate ' + data.networks.length + ' reti WiFi', 'success');
                    } else {
                        showNotification('‚ö†Ô∏è Nessuna rete WiFi trovata', 'warning');
                    }
                })
                .catch(err => showNotification('‚ùå Errore scansione: ' + err, 'error'));
        }

        function selectWiFiNetwork(ssid) {
            document.getElementById('wifi-ssid').value = ssid;
            document.getElementById('wifi-password').focus();
            showNotification('‚úÖ SSID selezionato: ' + ssid, 'success');
        }

        function connectToWiFi() {
            const ssid = document.getElementById('wifi-ssid').value.trim();
            const password = document.getElementById('wifi-password').value.trim();
            
            if (!ssid) {
                showNotification('‚ùå SSID non specificato', 'error');
                return;
            }
            
            if (!confirm('Connettere a "' + ssid + '"?\nLa connessione potrebbe interrompersi.')) {
                return;
            }
            
            showNotification('‚è≥ Connessione a "' + ssid + '" in corso...', 'warning');
            
            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);
            formData.append('interface', 'wlan0');
            
            fetch('/api/wifi/connect', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ ' + data.message + '\nRiconnessione in corso...', 'success');
                    
                    // Tenta riconnessione dopo alcuni secondi
                    setTimeout(() => {
                        window.location.reload();
                    }, 8000);
                } else {
                    showNotification('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('‚ö†Ô∏è Timeout (normale). Verifica la connessione...', 'warning'));
        }

        function forgetAllWiFiNetworks() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nStai per cancellare TUTTE le reti WiFi salvate.\n\nSe non sei connesso via Ethernet, perderai la connessione.\n\nContinuare?')) {
                return;
            }
            
            showNotification('üóëÔ∏è Cancellazione reti WiFi...', 'warning');
            
            fetch('/api/wifi/forget-all', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('‚úÖ ' + data.message, 'success');
                } else {
                    showNotification('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => showNotification('‚ùå Errore: ' + err.message, 'error'));
        }

        function openNetworkModal() {
            document.getElementById('networkModal').style.display = 'block';
            console.log('‚úÖ Network Modal aperto');
            
            // Carica la configurazione attuale della rete
            fetch('/api/network/info')
                .then(r => r.json())
                .then(data => {
                    console.log('[DEBUG] Network info:', data);
                    
                    if (data.success && data.network) {
                        const net = data.network;
                        const mode = net.mode || 'DHCP';
                        const currentIp = net.current_ip || 'N/A';
                        const staticIp = net.static_ip || '';
                        const gateway = net.gateway || '192.168.1.1';
                        const dns = net.dns || '8.8.8.8';
                        const iface = net.interface || 'wlan0';
                        const networkName = net.network_name || '--';
                        
                        // Aggiorna i display informativi
                        document.getElementById('current-network-display').textContent = networkName;
                        document.getElementById('current-ip-display').textContent = currentIp;
                        document.getElementById('current-mode-display').textContent = mode === 'STATIC' ? 'IP Statico' : 'DHCP (Automatico)';
                        document.getElementById('current-gateway-display').textContent = gateway || '--';
                        
                        // Aggiorna i radio button
                        if (mode === 'STATIC') {
                            document.getElementById('ip-static').checked = true;
                            document.getElementById('ip-dhcp').checked = false;
                            document.getElementById('static-ip-section').style.display = 'block';
                            document.getElementById('dhcp-section').style.display = 'none';
                        } else {
                            document.getElementById('ip-dhcp').checked = true;
                            document.getElementById('ip-static').checked = false;
                            document.getElementById('dhcp-section').style.display = 'block';
                            document.getElementById('static-ip-section').style.display = 'none';
                        }
                        
                        // Popola i campi
                        document.getElementById('network-interface').value = iface;
                        document.getElementById('dhcp-interface').value = iface;
                        document.getElementById('static-ip').value = staticIp;
                        document.getElementById('gateway-ip').value = gateway;
                        document.getElementById('dns-servers').value = dns;
                        
                        // Mostra log
                        console.log(`üì± IP Corrente: ${currentIp} | Modalit√†: ${mode}`);
                    } else {
                        console.error('[ERROR] Risposta non valida:', data);
                        document.getElementById('current-ip-display').textContent = 'Errore';
                        document.getElementById('current-mode-display').textContent = 'Errore';
                    }
                })
                .catch(err => {
                    console.error('[ERROR] Errore caricamento network info:', err);
                    document.getElementById('current-ip-display').textContent = 'Errore';
                    document.getElementById('current-mode-display').textContent = 'Errore';
                });
        }

        function closeNetworkModal() {
            document.getElementById('networkModal').style.display = 'none';
        }

        function openSecurityModal() {
            document.getElementById('securityModal').style.display = 'block';
            console.log('‚úÖ Security Modal aperto');
        }

        function closeSecurityModal() {
            document.getElementById('securityModal').style.display = 'none';
        }

        function saveSettings() {
            const newUsername = document.getElementById('new-username').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            const disableAuth = document.getElementById('disable-auth').checked;

            if (newPassword && newPassword !== confirmPassword) {
                showNotification('Le password non corrispondono!', 'error');
                return;
            }

            if (!newUsername && !newPassword && !disableAuth) {
                showNotification('Inserisci almeno un campo da cambiare', 'info');
                return;
            }

            const data = new FormData();
            if (newUsername) data.append('new_username', newUsername);
            if (newPassword) data.append('new_password', newPassword);
            data.append('disable_auth', disableAuth ? 'true' : 'false');

            fetch('/api/settings/save', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    showNotification('Impostazioni salvate! Effettua nuovamente il login.', 'success');
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 2000);
                } else {
                    showNotification('Errore: ' + (response.error || 'Errore sconosciuto'), 'error');
                }
            })
            .catch(err => {
                showNotification('Errore di connessione: ' + err, 'error');
            });
        }

        // Setup radio buttons per IP mode
        document.addEventListener('DOMContentLoaded', function() {
            const ipDhcpRadio = document.getElementById('ip-dhcp');
            const ipStaticRadio = document.getElementById('ip-static');
            const dhcpSection = document.getElementById('dhcp-section');
            const staticIpSection = document.getElementById('static-ip-section');

            if (ipDhcpRadio && ipStaticRadio) {
                ipDhcpRadio.addEventListener('change', function() {
                    if (this.checked) {
                        dhcpSection.style.display = 'block';
                        staticIpSection.style.display = 'none';
                    }
                });

                ipStaticRadio.addEventListener('change', function() {
                    if (this.checked) {
                        dhcpSection.style.display = 'none';
                        staticIpSection.style.display = 'block';
                    }
                });
            }

            // Chiudi modal quando clicchi fuori
            window.onclick = function(event) {
                const networkModal = document.getElementById('networkModal');
                const securityModal = document.getElementById('securityModal');
                if (event.target == networkModal) {
                    networkModal.style.display = 'none';
                }
                if (event.target == securityModal) {
                    securityModal.style.display = 'none';
                }
            }
        });

        // Carica configurazione al caricamento pagina
        window.onload = function() {
            // Carica hostname e aggiorna il titolo della pagina
            fetch('/api/network/info')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.hostname) {
                        document.getElementById('page-title').textContent = `${data.hostname} - Video Stream Manager`;
                    }
                })
                .catch(err => console.log('Errore caricamento hostname:', err));

            // Carica configurazione stream
            fetch('/api/config')
                .then(r => r.json())
                .then(config => {
                    // Popola form MJPG
                    const mjpgForm = document.getElementById('mjpg-form');
                    mjpgForm.elements['device'].value = config.mjpg.device || '/dev/video0';
                    mjpgForm.elements['resolution'].value = config.mjpg.resolution || '640x480';
                    mjpgForm.elements['framerate'].value = config.mjpg.framerate || 15;
                    mjpgForm.elements['quality'].value = config.mjpg.quality || 85;
                    mjpgForm.elements['port'].value = config.mjpg.port || 8080;
                    document.getElementById('mjpg-autostart').checked = config.mjpg.autostart || false;

                    // Carica impostazioni autenticazione MJPG
                    const mjpgAuthEnabled = config.mjpg.auth_enabled !== false; // Default true
                    document.getElementById('mjpg-auth-enabled').checked = mjpgAuthEnabled;
                    document.getElementById('mjpg-auth-fields').style.display = mjpgAuthEnabled ? 'block' : 'none';
                    document.getElementById('mjpg-auth-username').value = config.mjpg.auth_username || 'stream';
                    document.getElementById('mjpg-auth-password').value = config.mjpg.auth_password || 'stream';

                    // Gestione sorgente MJPG
                    const mjpgSource = config.mjpg.source_type || 'device';
                    if (mjpgSource === 'video') {
                        document.getElementById('mjpg-source-video').checked = true;
                        document.getElementById('mjpg-device-group').style.display = 'none';
                        document.getElementById('mjpg-video-group').style.display = 'block';
                        document.getElementById('mjpg-upload-section').style.display = 'block';

                        const videoPath = config.mjpg.video_path || '';
                        loadVideoList('mjpg', videoPath);
                    } else {
                        document.getElementById('mjpg-source-device').checked = true;
                    }
                    
                    // Popola form RTSP
                    const rtspForm = document.getElementById('rtsp-form');
                    rtspForm.elements['device'].value = config.rtsp.device || '/dev/video0';
                    rtspForm.elements['resolution'].value = config.rtsp.resolution || '640x480';
                    rtspForm.elements['framerate'].value = config.rtsp.framerate || 25;
                    rtspForm.elements['bitrate'].value = config.rtsp.bitrate || '1000k';
                    rtspForm.elements['port'].value = config.rtsp.port || 8554;
                    document.getElementById('rtsp-autostart').checked = config.rtsp.autostart || false;

                    // Carica impostazioni autenticazione RTSP
                    const rtspAuthEnabled = config.rtsp.auth_enabled !== false; // Default true
                    document.getElementById('rtsp-auth-enabled').checked = rtspAuthEnabled;
                    document.getElementById('rtsp-auth-fields').style.display = rtspAuthEnabled ? 'block' : 'none';
                    document.getElementById('rtsp-auth-username').value = config.rtsp.auth_username || 'stream';
                    document.getElementById('rtsp-auth-password').value = config.rtsp.auth_password || 'stream';

                    // Gestione sorgente RTSP
                    const rtspSource = config.rtsp.source_type || 'device';
                    if (rtspSource === 'video') {
                        document.getElementById('rtsp-source-video').checked = true;
                        document.getElementById('rtsp-device-group').style.display = 'none';
                        document.getElementById('rtsp-video-group').style.display = 'block';
                        document.getElementById('rtsp-upload-section').style.display = 'block';

                        const videoPath = config.rtsp.video_path || '';
                        loadVideoList('rtsp', videoPath);
                    } else {
                        document.getElementById('rtsp-source-device').checked = true;
                    }
                })
                .catch(err => {
                    console.error('Errore caricamento configurazione:', err);
                    showNotification('Errore nel caricamento della configurazione', 'error');
                });

            // Carica informazioni di rete
            fetch('/api/network/info')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.hostname) {
                        document.getElementById('hostname-input').placeholder = `Attuale: ${data.hostname}`;
                        // Carica info IP se disponibili
                        if (data.network.current_ip) {
                            console.log('IP attuale:', data.network.current_ip);
                        }
                    }
                })
                .catch(err => console.error('Errore caricamento info rete:', err));
        };

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ URL copiato negli appunti!', 'success');
                }).catch(err => {
                    console.error('Errore nella copia:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('‚úÖ URL copiato negli appunti!', 'success');
        }

        function copyMjpgUrl() {
            const mjpgLink = document.getElementById('mjpg-url-link');
            const text = mjpgLink.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ URL MJPG copiato negli appunti!', 'success');
                }).catch(err => {
                    console.error('Errore nella copia:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
            return false;
        }

        function copyRtspUrl() {
            const rtspLink = document.getElementById('rtsp-url-link');
            const text = rtspLink.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ URL RTSP copiato negli appunti!', 'success');
                }).catch(err => {
                    console.error('Errore nella copia:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
            return false;
        }

        // Event listener per copiare MJPG URL al click
        document.addEventListener('DOMContentLoaded', function() {
            const mjpgUrlDiv = document.getElementById('mjpg-url');
            if (mjpgUrlDiv) {
                mjpgUrlDiv.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'A') {
                        e.preventDefault();
                        const link = document.getElementById('mjpg-url-link');
                        copyToClipboard(link.textContent);
                    }
                });
            }
        });
    </script>
</body>
</html>